package main

import (
	"fmt"
	"log"
	"time"

	"github.com/nbd-wtf/go-nostr"
)

func main() {
	pool := nostr.NewRelayPool()
	errchan := pool.Add("wss://nostr.688.org", nostr.SimplePolicy{Read: true, Write: true})
	//pool.Add("wss://relay.nostr.com/", nostr.SimplePolicy{Read: true, Write: true})
	//pool.Add("wss://nostrrelay.example.com/", nostr.SimplePolicy{Read: true, Write: true})
	go func() {
		for err := range errchan {
			fmt.Println(err.Error())
		}
	}()
	//pool.Add("wss://nostrrelay.example.com/", nostr.SimplePolicy{Read: true, Write: true})

	go func() {
		for notice := range pool.Notices {
			log.Printf("%s has sent a notice: '%s'\n", notice.Relay, notice.Message)
		}
	}()
	//t := time.Now()
	//t = t.Add(-4 * time.Hour)
	//ids := []string{"d6bee3593951e1d81283250f6bb4241bcf6da036b3dae1ad7aff9107bbeee2f0", "363b07a681e38063e7572e3fefe90936e0d2f743a4e9f4d582e63c33ce276b9e", "4873e66c79f31ed992d43acf0d33d52628a274379cf8e976b42e83293cfc57e8", "d04f33d5cb7c39f8cbc851b10380b11c958790b67b856628e88769aa00980c8e", "19c30d25ec25e674e839c2762d814095bfdfdacb68a2db1e7e2b50ef695bc5a6", "15458787661b4d4d15c2ed0fa685d4b1e47834ba10bd2dc9f4bb198090153a30", "f069b38d1561acbfc5cdf95798edb0985dd8a29786f60f5f23b72f0d17efb8ad", "6842710df729feee231effe99e40897436df1ff26482df3f0378400ad75da5c2", "95bc76af0841ec18906c87143146a05a991c3806e64c3a3ab5a83c6f19a7a005", "8d54cfec758c45305d8697a7a73c9cea71683da47cf56a98a74cc03681232ad5", "499a67b76f0d6c9bf2661b95bfff03bab2dfbfbd274d53b51fcb3d6ec987b175", "2b678a06aa839d9c2e7ef8bb05e8fd2e1d4e07b0eee7fffddf9fb5045b6120e0", "32ac55ea5035556aa215741df0d2a6d47d9f4b1da7b0d3218a3f3c2a98b95700", "159fef79bd807a0213c04967bd8f3d805a7aa04f95b06372ae257cbc00097bbf", "433d58cbf951b21eb19568192d076884f32c803e661651099bc9e00de5d18c77", "862460890f0e1ec6726bb8f0e6ae22d6e0a596a3bd7e8db62589961a7da35a70", "b1206de9651308ac6f17d7933bece16d94ce77438e2a5d5df4625ebc7002eee9", "62a6f53bf689f2a1caf9b4fb854abc05e5966cadad683e340e181ac8df15604f", "75e3d998847f07c3ca890b2fc6d2b0921b43d0b5a4a6cbd71a3a1c7a4e9c0001", "3d159cd3ea4d8d707c82ab3e8fac0caf49201c633915b92eb935162ade6f87e6", "f3345bcd72b4b75368fc2bed12b90fb2658161d7ac32fc6fdfff5fa13a160bd7", "ea25800b7f504bb2ae1bd1b1e8767f0e14b9d8e38db3dfe7a668ad68d31156f4", "671949e9bec8a360d666bcca4d9fe40ef326965d37bceb46c77fc7132f4b94bf", "014b2b169efd9b85f5416d340acfb69f76703658298ab87c3beca92faa0d93fe", "9310fa49ff981bdc57ee2f1094d8081a158d7fb66687c83ec7eceb86ab1b8454", "9e105db0435e9f491a3953a13823e96aad089c49b84d968dc43f8650631b688d", "a6828e8e8e07cd5184a8cfb0c7a9603d2ee8b8e738aa39bbcb2f912c0599b520", "7dac5f4e3bdb7c2d31d996cc68a40ae91be27dddd6b8460362b89f41f2e1fbc6", "fbaf9d2cb167b9baf283b44c6c48e7dfe6db926008d569d3ed20e1c2d4445cf2", "456282f091209aabd540eea24290b041fe610bca6a6dedd102ce548d13f831dd", "77de4708a8e7aece22957d6d9546a87c5529efb48f3212e4563008971b00855f", "2baf3ae17729cb23f2825723e80f48bffc7f7c4435d6dfde7856e4872f8370cf", "42abab4194b53afa468eade45da054ce2227ce2746500da2aa8761a10c19bce0", "6cad5f3e4ed12162a27d0e3872416dbbe61160bac8af199e9ea36a36a38d6d08", "fc1defc3753ca7e0250e2f1969e830814143407d227c4ede2f96c3a27bca16d0", "4deef916206677b12c0f767f10eb38f02fda77a56f29383f3df5541b62d974fc", "659b398363804b8acaef70b0d45e5e4f86f09af91c0b387697b8a55e45ad3ec9", "e04ff7b6e38623523cbb90766bf258d025c0aedb8be79fcacfb3ef3e2f9ceda0", "17c6d574adb1f8597fa272297615dc5b523b78d8416ebfffab9ba5d640275be2", "3f44d31e3062a21d164f5021680cd5017fdc667e487c8c8635fe0f37a5520cb8", "f981ca7108c98addb662d88830ec0432127818432cdf37388a89e9c1b1003bdb", "370dcfd3faf2992614c808c2d926a57193579523535782f28712b001ee364cf7", "6d9af36228dfc3e52bfd007933ae1a46093aa30553f3f10b06d44cffa1ad98cb", "36f59bf48597a734bc3620d57f0c2e0b37b6f0baf8c5db2ac72f7332f2dedf33", "5e6a5488a059ea6b7d46322bee78280b5018f2a3890dc17b9e721fe0791fd0a4", "3c235cfbb7898139f1a4a33db6841a504f5d8fdf21dfb4c79fed45247b4e8f67", "7c8a1c1d3c55742daca687f8e185ed442ff994caaafef95ff7cdf498931d65aa", "e2d66fdde5bc45810ec25a02346e9469b7613f07b2bf7a80f053e8353a85a027", "e1eaf380e99cd62cac51ca0a48e94b7edc736672a0a7df8d2ed7ea81004bb3d8", "e3fadac58d1edacb5bb2dec0f6bb849896c10d7f5d85d9b7f1d95e37e9c3a3e0", "7da8efc022671a80a5df5b5cf05e53fad6879c122a6b268b8dc2412084822772", "89db1f43b20eb6a26f4e644e35023b92f616636a2e76c88ba50eb19c4e1cca65", "94254e533487ff031abd586b06cc99ddfb41dd9ae632e580778d8a2dbc5a7b85", "50fce7a534bef8bf83b46aaa9ef22f0d21cfa346a5cd04e43db2cc9d0f7fc4d5", "2b091f7409c87eeb51f18d5a7d07b8721df6046626b15e0d0be6a93e6719e381", "fcf3eb7fbeea147930d3bb02bd5d675276d3567c5dcb5d2a37cd7c99391950a4", "f49407aeb6e9b597a25c9897218e045ccbac0ee4403419503267b1246cd840b2", "e6137504d05a7673ddc78c49c126307bb9dd76bc087407b0f81c75c0200f42b7", "0db04ffe38782ccbc773d6eca98a7fd277102781e699428c2df0083702c7b13e", "348092b98cba1a10cd1ee57eb43feac70a8b392a108ce595d8af5503b78bdfbc", "19abd2df429a824e5fd2cae8bd4b4a14b426c652071f1dc342818d4097b003cb", "5544b983ca96f53ae7d4b53e74d6d350b28c2b7ecc21979a16aa91c554f30617", "a8caa190711c5bcac4171565edee2f38aa6eaaf74cdfc4fcb9a7189990944a4f", "122017649630fa05e8561ee9fc06c7d3b3c527c05900d6247880468f17332fe3", "5e94d22db6c453638464edb458ff0f025907d62b88582fd5ddad39f7c18be9ac", "e70d66196acd0a01f416784d6c03b376b48bbd826eb0ff7fa7a759bd6ebb565d", "ed1d3e6603aca3c862fa2c5b9a5dc9751bf24c18149d7e924e50ecbe58293a51", "355a2643175d4e956af1832f109702dd022465f4d05dd529c29756cc58aa728e", "6da3b0c66bcc5276adb3b80cdf168ea1a718468301c2c7256d33268bbbaf5edc", "0539227ab2cf2629e413dbc31613ca108d106ecd75708669e5666e73bb612b8d", "6103d93f57ad2da9e474cb4609ddef314ebb77f857c324c111e476502b86f0b6", "2ec93c7002423c03d6c8408bc96417bd910aaf7647bb62fc3c630358f859383d", "50d45be3e0a71c02b5fba69ab0bf728de8d782f2c85dbf6a548eac0d5508a425", "d643143f38232141725dd1bed70e60f8316e8173dd3f643a2d6e04a09e6a532e", "a4fbae84ceac69b25364956a05b0bcfbf72b6cec5dc737800a2b7682af4b5fae", "2aaf7009c561e4a723845b29fb041c8b1a7174765880febbd544f67eed2af17e", "65334e109f23eab7a1789620091ca70e645261d502f448a668790d6b98046f07", "8b6ba421763445b0762a2a22bfa0185c06c01836862d447245ae6289b9ee8b33", "dd966f685d025de7bb5a1a5e9d3444761e254f6659704d539b3b8a7fe99b1b39", "0508c0dffe776e11647754f3eba4670a2643c7e0371267fe010f5a35bfd42d02", "44469a9fa9052c39dc330eeda82213f007ccf42c0365e8713a644e455ed9dda0", "d1faf8ed662d6ce9819a86b9eb2ead66dcfe387b30e58c95b22d8d3d8749ed92", "606d7d7f4553c19aba41c42c393e8a90583bcfe216a3cc1fcd26c10edf975fc8", "300faf08ebcd0d9e5ef82ed9da998a22c5e35cef43639251b3ae7dbb617c16a6", "73c81f566c57abecafa1824a04b40b3377c11c6c3d195bc6d0f9db20fbe19c4c", "4ef0f09fa61f15b646afdf591133083a51147e87c71fc77d357f509192490dc1", "0888e2087519cab7ee8e60d45af3c1a862eae78ce8686db86b8bca3d44832ed5", "3d7ed0e53eaca5694681d8918c5fb8f71b820468d7b6e08ebfbce375747abcc8", "3eaa3ed963d1627b489977654a2ccbaae9c29fcab3a703c63cbe479645b2381d", "b2c555ccc1b2594699c448b742013ef076ff186c87aaa2378f3b775bc5fc1247", "c612b945f2ff8a0f8739fe8dbab1197b24304f09e2e031ee910d56507637c452", "bf99fa47346c30c343107bf8f5fe3d29c68fecb83b6ed28984800e6c798af1ac", "82393f2962cf662fd41dee4b2e943736f9919f4cde648c1a49e6a1a5104f4462", "c9e67e8ba3ab14c9c30099113baaa507d50e0092d3f64ae592292433c476f1fd", "91114c3fc4ff9fb24368aebb0fa6c6f28ab01d61a9587ecf2fa2b84b82f8ed5c", "501bd2c1522d5e8e70cffc812fbe5ba9d8197ef45ad9a62563d04c33f12114d0", "8a654f7d3ce938b31db62256a297b0af02f8c53aa725b8c990d9f69b88969374", "6e248d613ff2f667aea8ae5691c6e196853fb0f73fd49c8ac22ebf78cd45768f", "cd1717a199456cceaddb4ba45beeb4ee22055f869edf222ad4e442fd83c1068f", "ed457ab09e38e29d5f58d46fc3f849d6368b9f41d4c55a4982c569b70f13989b", "7573fc174a83675fc4a40c8e3460dfdf503aebfff926076b05aeeb638fdd5546", "2de90e8967434354c472fcd6d9bf443c8cbc03c48f00952cae727b9b02d4f956", "a291f2a995427e0b23a45d6d9f7f9aa666cb14b9924c3259dd2d1e14a6988728", "744877c57073d4c6a6ea4b79a5957fcf62c0edc7334e9867ac344a6bb50f75de", "b668cfd30311d191055d6fbc76f075a95cc7435f0af399c25647859b28bd02f8", "2dbc2541f6acad5c056ae5c7277fa569d505badacfc168e987e7823745315e75", "213fd838e50fe1978358998f43e6c187b8b07ce5355ea7b8c759170edd665649", "6ed983080b4df73fac7c43c580445669651fda781935ca2a65d68151088d58a0", "6e965359bdc13920a5d53c2a980f60a9d9dca1937eb61804a18e8685243aef32", "4e5cb2bfb4920fce2fcb80f86a8826d023f7977f7158b13ac68a2ec920f5cce0", "fab488927a727f2ec4ce94a3381f892697e52c3a119a046ddf6dabec3a3153c0", "d7f26d1e2c96101f79556b35aca9c6f589f9ecb6c9c92d7eb5a637c0fd4bcc62", "f771d4e90befd7ffac4333d4059659e092ab8402a602afd5d1229de78b1e7007", "449a9d622d7095f0feeb048a0418456a20bd6b8231211963a4ba6954088d75f1", "6e1a5bbe91d50f3193023c3007dfe2987a9a6fadee465e0ad09206972b51201b", "7e8f1f92786c034466d243437a46afa4046b23fe742703c7742cedd5a4515333", "6e7bf2b0e27fe120bf8b36773af82187ca1b899f08bc3c92d28a804869d54b09", "eeb7169f116426dfaed26defde9e235ef20e42c9f04a3d257e848f0ae3a1a86c", "066ea7b6e360d275e97f670e45e2f0bc1b2b4e3951efdd3023fd798e0a43d450", "99cfd3d67a665d53eab5f21df191237a361231fe941c1bac9c2ed1a5988b29bb", "69b881ddfcb37f46d5e972c57210ca7d19a46fddb911b803573211a3262f9b1c", "b254e0ecbcfae2e0999887797562c62646ef55cee0c6b6b4d220489c04e414ff", "9c616e7ae41f4bddbe4ee5c43415566fdd8d9ab53e167b7b3dfcbb3ca9d9eab3"}
	_, events, unsub := pool.Sub(nostr.Filters{
		{
			//IDs: ids, //[]string{},
			//Authors: []string{"543210b5f6c3071c3135d850449f8bf91efffb5ed1153e5fcbb2d95b79262b57"},
			//Kinds:   []int{640001}, // or {1}
			//Since:   &t,
		},
	})
	allevents := make(map[string]nostr.Event)
	gotResult := false
	var tries int64 = 0
	kinds := make(map[int]int64)
	var number int64
L:
	for {
		select {
		case e := <-nostr.Unique(events):
			//fmt.Println(e)
			kinds[e.Kind]++
			number++
			allevents[e.ID] = e
			gotResult = true
		case <-time.After(time.Second * 2):
			if gotResult {
				break L
			}
			tries++
		}
	}
	//for _, event := range allevents {
	//	fmt.Println(event.ID)
	//	fmt.Println()
	//}
	unsub()
	//fmt.Println("MISSING EVENTS:")
	//for _, id := range ids {
	//	if _, ok := allevents[id]; !ok {
	//		fmt.Println(id)
	//	}
	//}
	fmt.Printf("%#v", kinds)
	//_, events, unsub = pool.Sub(nostr.Filters{
	//	{
	//		Authors: []string{"0ded86bf80c76847320b16f22b7451c08169434837a51ad5fe3b178af6c35f5d"},
	//		Kinds:   []int{nostr.KindTextNote}, // or {1}
	//	},
	//})
	//
	//go func() {
	//	for event := range nostr.Unique(events) {
	//		log.Print(event)
	//	}
	//}()
	//
	//time.Sleep(5 * time.Second)
	//unsub()
	//time.Sleep(5 * time.Second)
	//sub.Unsub()
}
